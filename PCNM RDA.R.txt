
library(vegan)
library(geosphere)


community_data <- read.csv("pbb_abundance.csv", row.names = 1)

geo_data <- read.csv("geo_coords.csv")


env_data <- read.csv("pesticide_risk.csv")



colnames(geo_data)[1] <- "sample_id"
colnames(env_data)[1] <- "sample_id"

meta <- merge(geo_data, env_data, by = "sample_id")
rownames(meta) <- meta$sample_id
meta <- meta[rownames(community_data), ] 



coords <- as.matrix(meta[, c("longitude", "latitude")])
geo_dist <- distm(coords)
geo_dist <- as.dist(geo_dist / 1000)  

pcnm_obj <- pcnm(geo_dist)
pcnm_vectors <- as.data.frame(pcnm_obj$vectors)


env_matrix <- cbind(pesticide_risk = meta$pesticide_risk, pcnm_vectors)


comm_dist <- vegdist(community_data, method = "bray")


db_model <- capscale(comm_dist ~ ., data = env_matrix)


anova(db_model, permutations = 999)               
anova(db_model, by = "margin", permutations = 999)  


plot(db_model)
